<!doctype html>
<html lang="en">
	<head>
		<title>three.js canvas - geometry - birds</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style> 
			body {
				color: #808080;
				font-family:Monospace;
				font-size:13px;
				text-align:center;

				background-color: #ffffff;
				margin: 0px;
				overflow: hidden;
			}

			#info {
				position: absolute;
				top: 0px; width: 100%;
				padding: 5px;
			}
                </style>
	</head>
	<body>

		<div id="container"></div>
		<div id="info"><a href="http://github.com/mrdoob/three.js" target="_blank">three.js</a> - birds demo</div>

		<script src="Three.js"></script>
		<script src="boat.js"></script>

		<script src="RequestAnimationFrame.js"></script>
		<script src="Stats.js"></script>

		<script>

			// Based on http://www.openprocessing.org/visuals/?visualID=6910
      
			var Boid = function() {

				var vector = new THREE.Vector3(),
				_acceleration, _width = 100, _height = 100, _depth = 100, _goal, _neighborhoodRadius = 20,
        _angle,
				_maxSpeed = 4, _maxSteerForce = 0.1, _avoidWalls = false;

				this.position = new THREE.Vector3();
				this.velocity = new THREE.Vector3();
				_acceleration = new THREE.Vector3();
        _direction = new THREE.Vector3();
        _angle = 0;
        this.speed = 0;
        
				this.setGoal = function ( target ) {

					_goal = target;

				};

				this.setAvoidWalls = function ( value ) {

					_avoidWalls = value;

				};

				this.setWorldSize = function ( width, height, depth ) {

					_width = width;
					_height = height;vector
					_depth = depth;

				};

				this.run = function ( boids ) {

          this.checkBounds();

          this.move();

				};
        
        this.getAngle = function(){
          return _angle;
        };
        
        this.speedup = function (delta) {
          if(speed<=0)
          this.speed += delta;
        };
        
        this.turn = function (delta) {
          _angle += delta;
          while (_angle > 2*Math.PI) _angle -= Math.PI;
          while (_angle < 0) _angle += Math.PI;
        };
        
				this.move = function () {
          this.velocity.x = Math.cos(_angle) * this.speed;
          this.velocity.z =  Math.sin(_angle) * this.speed;
					this.position.addSelf( this.velocity );
				};

				this.checkBounds = function () {

					if ( this.position.x >   _width ) this.position.x = - _width;
					if ( this.position.x < - _width ) this.position.x =   _width;
					if ( this.position.y >   _height ) this.position.y = - _height;
					if ( this.position.y < - _height ) this.position.y =  _height;
					if ( this.position.z >  _depth ) this.position.z = - _depth;
					if ( this.position.z < - _depth ) this.position.z =  _depth;

				};
			}

		</script>

		<script>

			var SCREEN_WIDTH = window.innerWidth,
			SCREEN_HEIGHT = window.innerHeight,
			SCREEN_WIDTH_HALF = SCREEN_WIDTH  / 2,
			SCREEN_HEIGHT_HALF = SCREEN_HEIGHT / 2;

			var camera, scene, renderer,
			birds, bird;

			var boid, boids;

			var stats;

			init();
			animate();

			function init() {

				camera = new THREE.PerspectiveCamera( 75, SCREEN_WIDTH / SCREEN_HEIGHT, 1, 10000 );
				camera.position.x = 0;
				camera.position.y = 100;
				camera.position.z = 100;
        origin = new THREE.Vector3(0,0,0);
        camera.lookAt(origin);

				scene = new THREE.Scene();

				birds = [];
				boids = [];

				for ( var i = 0; i < 1; i ++ ) {

					boid = boids[ i ] = new Boid();
					boid.position.x = 0;
					boid.position.y = 0;
					boid.position.z = 0;
					boid.velocity.x = 1;
					boid.velocity.y = 0;
					boid.velocity.z = 0;
					boid.setAvoidWalls( true );
					boid.setWorldSize( 100, 100, 100 );

					bird = birds[ i ] = new THREE.Mesh( new Boat(), new THREE.MeshBasicMaterial( { color:Math.random() * 0xffffff } ) );
					bird.phase = Math.floor( Math.random() * 62.83 );
					bird.position = boids[ i ].position;
					bird.doubleSided = true;
					bird.scale.x = bird.scale.y = bird.scale.z = 5;
					scene.add( bird );

				}

				renderer = new THREE.CanvasRenderer();
				// renderer.autoClear = false;
				renderer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );

				document.addEventListener( 'keydown', onDocumentMouseMove, false );
				document.body.appendChild( renderer.domElement );

				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.left = '0px';
				stats.domElement.style.top = '0px';

				document.getElementById( 'container' ).appendChild(stats.domElement);

			}

			function onDocumentMouseMove( event ) {
        if (event.which == 38) {
          boids[0].speedup(1); 
        }
        if (event.which == 40) {
          boids[0].speedup(-1); 
        }
        if (event.which == 37) {
          boids[0].turn(-0.2);
        }
        if (event.which == 39) {
          boids[0].turn(0.2);
        }
			}

			//

			function animate() {

				requestAnimationFrame( animate );

				render();
				stats.update();

			}

			function render() {

				for ( var i = 0, il = birds.length; i < il; i++ ) {

					boid = boids[ i ];
					boid.run( boids );

					bird = birds[ i ];

					color = bird.materials[ 0 ].color;
					color.r = color.g = color.b = ( 500 - bird.position.z ) / 1000;
					bird.rotation.y = -boid.getAngle()+Math.PI/2;
          console.log(bird.rotation.y);
					//bird.rotation.z = Math.asin( boid.velocity.y / boid.velocity.length() );

					//bird.phase = ( bird.phase + ( Math.max( 0, bird.rotation.z ) + 0.1 )  ) % 62.83;
					//bird.geometry.vertices[ 5 ].position.y = bird.geometry.vertices[ 4 ].position.y = Math.sin( bird.phase ) * 5;

				}

				renderer.render( scene, camera );

			}

		</script>

	</body>
</html>
